<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <title>Chat Room - ChatsYok!</title>
    <link rel="icon" type="image/png" href="/img/favico/32x32.png" sizes="32x32">    
    <link rel="stylesheet" href="/css/chat.css">
    <link rel="stylesheet" href="/css/modal.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <div id="chat-page">
        <header class="top-bar">
            <div class="header-left-group">
                <button id="back-btn" aria-label="Kembali">&larr;</button>
                
                <img id="header-char-avatar" class="header-avatar" src="" alt="" style="display: none;">
                <div class="header-char-info">
                    <h3 id="header-char-name">Memuat...</h3>
                    <span id="header-status" class="header-status-text">Online</span>
                </div>
            </div>

            <div class="header-right">
                <button id="menu-btn" aria-label="Opsi Chat">&#x22EE;</button>
                
                <div id="chat-dropdown" class="chat-dropdown-content">
                    <button id="mobile-persona-btn-dropdown" class="dropdown-item">ğŸ­ Atur Peran</button>
                    
                    <button id="btn-save-session-dropdown" class="dropdown-item">ğŸ’¾ Simpan Sesi</button>
                    <button id="btn-new-chat" class="dropdown-item">âœ¨ Chat Baru</button>
                    
                    <hr style="margin: 4px 0; border: 0; border-top: 1px solid var(--border-color);">
                    
                    <button id="delete-chat-item" class="dropdown-item text-danger">ğŸ—‘ï¸ Hapus Chat</button>
                </div>
            </div>
        </header>

        <main id="chat-content">
            <aside class="chat-left-panel">
                <button id="close-left-panel" class="mobile-close-btn">&times;</button>
                <div class="character-stage-left">
                    <img id="mai-sprite" src="" alt="Avatar MAI" class="anim-idle">
                </div>
                <div class="profile-info-container">
                    <h4 class="profile-name">Loading...</h4>
                    <span class="status-badge">Online</span>
                    <button id="mobile-persona-trigger" style="display: none;">ğŸ­ Atur Peran Saya</button>
                </div>
                <hr class="panel-divider">
                <div class="chat-sessions-container">
                    <h5>Riwayat Chat</h5>
                    <div id="chat-history-list">
                        <p class="empty-state">Belum ada riwayat.</p>
                    </div>
                </div>
            </aside>

            <div class="chat-main-wrapper">
                <section class="chat-center-panel">
                    <div class="chat-transcript" id="chat-transcript"></div>
                    
                    <div class="chat-input-area">
                        <div id="attachment-preview" class="attachment-preview hidden">
                            <div class="preview-wrapper">
                                <img id="preview-img" src="" alt="Preview">
                                <button id="btn-cancel-attach" class="btn-close-preview">&times;</button>
                            </div>
                        </div>
                        
                        <button id="upload-btn" aria-label="Lampirkan Gambar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                        
                        <input type="file" id="file-input" accept="image/*, application/pdf" style="display: none;">                        
                        <textarea id="chat-input" placeholder="Ketik pesan..." rows="1"></textarea>
                        
                        <button id="send-button" aria-label="Kirim">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </section>

                <aside class="chat-right-panel">
                    <div class="persona-box">
                        <div class="persona-header">
                            <h3>ğŸ­ Peran Anda</h3>
                            <p>Identitas dalam cerita ini:</p>
                        </div>
                        <div id="persona-display-container">
                            <div id="persona-text-display" class="persona-content">
                                <em class="text-muted">Belum ada peran yang diatur.</em>
                            </div>
                            <button id="edit-persona-btn" class="action-btn outline-btn">Ubah Peran</button>
                        </div>
                        <div id="persona-edit-container" class="hidden">
                            <textarea id="user-persona-input" placeholder="Contoh: Saya adalah detektif..."></textarea>
                            <div class="persona-actions">
                                <button id="save-persona-btn" class="action-btn">Simpan</button>
                                <button id="cancel-persona-btn" class="action-btn secondary-btn">Batal</button>
                            </div>
                        </div>
                        <p id="persona-status" class="status-text"></p>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div id="toast" class="toast hidden">Pesan disalin!</div>

    <div id="mobile-backdrop" class="mobile-overlay-backdrop"></div>
    <div id="mobile-persona-popup" class="persona-popup-mobile">
        <button id="close-persona-popup" class="mobile-close-btn">&times;</button>
        <div id="mobile-persona-content-area"></div>
    </div>
    <div id="custom-confirm-modal" class="guest-modal-overlay">
        <div class="guest-modal-content" style="max-width: 400px; text-align: left;">
            <h3 id="confirm-title" style="margin-top: 0; color: var(--text-primary);">Konfirmasi</h3>
            <p id="confirm-msg" style="color: var(--text-secondary); margin: 15px 0;">Apakah Anda yakin?</p>
            <div class="confirm-actions">
                <button id="btn-confirm-cancel" class="btn btn-secondary">Batal</button>
                <button id="btn-confirm-yes" class="btn btn-danger">Ya, Hapus</button>
            </div>
        </div>
    </div>
    <div id="image-viewer-modal" class="image-viewer-modal">
        <span class="close-viewer">&times;</span>
        <img class="viewer-content" id="full-image">
    </div>

    <div id="save-session-modal" class="guest-modal-overlay">
        <div class="guest-modal-content" style="max-width: 400px; text-align: left;">
            <h3 style="margin-top: 0; color: var(--text-primary);">Simpan Percakapan</h3>
            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                Berikan judul agar mudah ditemukan kembali nanti.
            </p>
            
            <div class="form-group">
                <label for="session-title-input" style="font-weight: 600; font-size: 0.9rem;">Judul Sesi</label>
                <input type="text" id="session-title-input" placeholder="Contoh: Belajar Sejarah..." 
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 5px;">
            </div>

            <div class="confirm-actions" style="margin-top: 20px;">
                <button id="btn-cancel-save" class="btn btn-secondary">Batal</button>
                <button id="btn-confirm-save" class="btn btn-primary">Simpan</button>
            </div>
        </div>
    </div>

    <div id="level-up-overlay" class="level-up-overlay hidden">
    <div class="level-up-box">
        <div class="level-stars">â­â­â­</div>
        <h1 class="level-title">LEVEL UP!</h1>
        <div class="level-number-container">
            <span class="level-label">LEVEL</span>
            <span id="new-level-display">2</span>
        </div>
        <p class="level-msg">Hebat! Kamu semakin sepuh!</p>
        <button id="btn-close-level" class="level-btn">Lanjut Chatting ğŸ˜</button>
    </div>
    <div class="confetti c1"></div>
    <div class="confetti c2"></div>
    <div class="confetti c3"></div>
    <div class="confetti c4"></div>
</div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="/js/firebase-config.js"></script>
    <script src="/js/auth-guard.js"></script> 
    <script src="/js/chat.js"></script>
</body>
</html>